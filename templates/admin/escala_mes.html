{% extends "base.html" %}
{% block title %}Escala {{ "%02d"|format(escala.mes) }}/{{ escala.ano }}{% endblock %}

{% block content %}

<h1>üìÖ Escala {{ "%02d"|format(escala.mes) }}/{{ escala.ano }}</h1>
<p style="color:#666;">Setor: <strong>{{ escala.setor or "Todos" }}</strong></p>

<div class="card" style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
  <a class="btn-outline" href="{{ url_for('admin_escalas') }}">‚Üê Voltar</a>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <div style="color:#666; font-size:14px;">
      <strong>Total de funcion√°rios:</strong> {{ por_func|length if por_func else 0 }}
    </div>

    {# ‚úÖ bot√£o PDF #}
    <a class="btn-outline"
       href="{{ url_for('admin_escala_mes_pdf', escala_mes_id=escala.id) }}"
       style="padding:8px 12px; border-radius:10px; text-decoration:none;">
      üìÑ Baixar PDF
    </a>

    {# ‚úÖ bot√£o excluir escala #}
    <form method="post" action="{{ url_for('admin_excluir_escala', escala_mes_id=escala.id) }}"
          onsubmit="return confirm('Tem certeza que deseja excluir esta escala? Isso apagar√° todos os itens do m√™s.');"
          style="margin:0;">
      <button type="submit" class="btn-danger" style="padding:8px 12px; border-radius:10px; border:none; cursor:pointer;">
        üóëÔ∏è Excluir escala
      </button>
    </form>
  </div>
</div>

<style>
  .cal-wrap{ overflow:auto; }
  .cal-table{ border-collapse: collapse; min-width: 1200px; width: 100%; }
  .cal-table th, .cal-table td{ border: 1px solid #e1e1e1; padding: 6px; font-size: 12px; text-align: center; white-space: nowrap; }
  .cal-table th{ background:#f4f6f8; font-weight: 700; position: sticky; top: 0; z-index: 3; }

  .sticky-col{ position: sticky; left: 0; z-index: 4; background: #fff; text-align: left !important; min-width: 260px; }
  .sticky-col .nome{ font-weight: 700; display:block; }
  .sticky-col .meta{ font-size: 12px; color:#666; display:block; margin-top:2px; }

  .badge{ display:inline-block; padding: 3px 7px; border-radius: 999px; font-size: 11px; font-weight: 700; }
  .b-plantao{ background:#0d6efd; color:#fff; }
  .b-exp{ background:#198754; color:#fff; }
  .b-folga{ background:#e9ecef; color:#333; }

  .cell{
    border-radius: 10px;
    padding: 7px 0;
    font-weight: 800;
    cursor: pointer;
    user-select: none;
    transition: transform .05s ease, filter .12s ease;
  }
  .cell:active{ transform: scale(0.98); }

  .tipo-PLANTAO_24H{ background:#0d6efd; color:#fff; }
  .tipo-EXPEDIENTE{ background:#198754; color:#fff; }
  .tipo-FOLGA{ background:#e9ecef; color:#333; }
  .cell:hover{ filter: brightness(0.95); }

  .legend{ display:flex; gap:16px; flex-wrap:wrap; margin-top: 14px; color:#666; font-size: 13px; align-items:center; }

  /* fallback caso voc√™ n√£o tenha .btn-danger no CSS global */
  .btn-danger{ background:#dc3545; color:#fff; }
  .btn-danger:hover{ filter: brightness(.95); }
</style>

{% if por_func %}

  {# ===== Ordena√ß√£o por nome ===== #}
  {% set lista_ordenada = [] %}
  {% for func_id in por_func.keys() %}
    {% set f = func_map.get(func_id) %}
    {% if f %}
      {% set _ = lista_ordenada.append((f.nome|lower, func_id)) %}
    {% else %}
      {% set _ = lista_ordenada.append(("zzz", func_id)) %}
    {% endif %}
  {% endfor %}
  {% set lista_ordenada = lista_ordenada|sort %}

  <div class="card cal-wrap">
    <table class="cal-table">
      <tr>
        <th class="sticky-col">Funcion√°rio</th>
        {% for d in dias %}
          <th>{{ "%02d"|format(d) }}</th>
        {% endfor %}
      </tr>

      {% for _, func_id in lista_ordenada %}
        {% set itens = por_func.get(func_id) %}
        {% set f = func_map.get(func_id) %}

        {# ===== Contadores por tipo ===== #}
        {% set c_plantao = namespace(v=0) %}
        {% set c_expediente = namespace(v=0) %}
        {% set c_folga = namespace(v=0) %}
        {% for it in itens %}
          {% if it.tipo == "PLANTAO_24H" %}
            {% set c_plantao.v = c_plantao.v + 1 %}
          {% elif it.tipo == "EXPEDIENTE" %}
            {% set c_expediente.v = c_expediente.v + 1 %}
          {% elif it.tipo == "FOLGA" %}
            {% set c_folga.v = c_folga.v + 1 %}
          {% endif %}
        {% endfor %}

        <tr>
          <td class="sticky-col">
            <span class="nome">üë§ {{ f.nome if f else "Funcion√°rio" }}</span>
            <span class="meta">
              {{ f.setor if f and f.setor else "-" }} |
              {{ f.escala_tipo if f and f.escala_tipo else "-" }}
              {% if f and f.plantao_base %} | Base: {{ f.plantao_base }}{% endif %}
            </span>

            <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
              <span class="badge b-plantao">24H: {{ c_plantao.v }}</span>
              <span class="badge b-exp">EXP: {{ c_expediente.v }}</span>
              <span class="badge b-folga">F: {{ c_folga.v }}</span>
            </div>
          </td>

          {# ===== Grade mensal (clic√°vel) ===== #}
          {% for d in dias %}
            {% set ns = namespace(status=None, obs=None) %}

            {% for it in itens %}
              {% set dia_item = it.inicio.strftime("%d")|int %}
              {% if dia_item == d %}
                {% set ns.status = it.tipo %}
                {% set ns.obs = it.observacao %}
              {% endif %}
            {% endfor %}

            <td title="Clique para editar | {{ ns.status or '-' }}{% if ns.obs %} ‚Äî {{ ns.obs }}{% endif %}">
              {% if ns.status == "PLANTAO_24H" %}
                <div class="cell tipo-PLANTAO_24H js-cell"
                     data-func="{{ func_id }}" data-dia="{{ d }}" data-tipo="PLANTAO_24H">24H</div>
              {% elif ns.status == "EXPEDIENTE" %}
                <div class="cell tipo-EXPEDIENTE js-cell"
                     data-func="{{ func_id }}" data-dia="{{ d }}" data-tipo="EXPEDIENTE">EXP</div>
              {% elif ns.status == "FOLGA" %}
                <div class="cell tipo-FOLGA js-cell"
                     data-func="{{ func_id }}" data-dia="{{ d }}" data-tipo="FOLGA">F</div>
              {% else %}
                <div class="cell js-cell"
                     style="background:transparent; color:#999; font-weight:600;"
                     data-func="{{ func_id }}" data-dia="{{ d }}" data-tipo="">-</div>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </table>
  </div>

  <div class="legend">
    <span><span class="badge b-plantao">24H</span> Plant√£o</span>
    <span><span class="badge b-exp">EXP</span> Expediente</span>
    <span><span class="badge b-folga">F</span> Folga</span>
    <span style="margin-left:auto; color:#999;">Clique na c√©lula para editar.</span>
  </div>

{% else %}
  <div class="card">
    <p>Nenhum item encontrado para esse m√™s.</p>
  </div>
{% endif %}

<script>
  // ‚úÖ ciclo de clique: (vazio) -> EXP -> FOLGA -> 24H -> EXP ...
  const NEXT = {
    "": "EXPEDIENTE",
    "EXPEDIENTE": "FOLGA",
    "FOLGA": "PLANTAO_24H",
    "PLANTAO_24H": "EXPEDIENTE"
  };

  function labelFor(tipo){
    if (tipo === "EXPEDIENTE") return "EXP";
    if (tipo === "FOLGA") return "F";
    if (tipo === "PLANTAO_24H") return "24H";
    return "-";
  }

  function classFor(tipo){
    if (tipo === "EXPEDIENTE") return "tipo-EXPEDIENTE";
    if (tipo === "FOLGA") return "tipo-FOLGA";
    if (tipo === "PLANTAO_24H") return "tipo-PLANTAO_24H";
    return "";
  }

  async function postForm(url, data){
    const form = new URLSearchParams();
    Object.keys(data).forEach(k => form.append(k, data[k]));
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: form.toString()
    });
    return res;
  }

  document.querySelectorAll(".js-cell").forEach(el => {
    el.addEventListener("click", async () => {
      const funcId = el.dataset.func;
      const dia = el.dataset.dia;
      const atual = (el.dataset.tipo || "").trim();
      const novo = NEXT[atual] || "EXPEDIENTE";

      // feedback r√°pido
      el.style.opacity = "0.6";

      try{
        const res = await postForm(
          "{{ url_for('admin_escala_editar_dia', escala_mes_id=escala.id) }}",
          { funcionario_id: funcId, dia: dia, tipo: novo }
        );

        const json = await res.json();
        if (!res.ok || !json.ok){
          alert((json && json.error) ? json.error : "Erro ao salvar.");
          return;
        }

        el.dataset.tipo = json.tipo;
        el.classList.remove("tipo-EXPEDIENTE", "tipo-FOLGA", "tipo-PLANTAO_24H");
        const cls = classFor(json.tipo);
        if (cls) el.classList.add(cls);

        el.textContent = json.label || labelFor(json.tipo);
        el.title = "Clique para editar | " + (json.tipo || "-");
      }catch(e){
        alert("Erro de conex√£o ao salvar.");
      }finally{
        el.style.opacity = "1";
      }
    });
  });
</script>

{% endblock %}
